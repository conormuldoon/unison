

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Unison.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
             
                <a href="index.html">
                    <h1 class="navbar-item">Unison React components</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Components</h3><ul><li><a href="ARLocationComponent.html">ARLocationComponent</a></li><li><a href="ChartComponent.html">ChartComponent</a></li><li><a href="ChartPopup.html">ChartPopup</a></li><li><a href="LeafletMap.html">LeafletMap</a></li><li><a href="LocationForm.html">LocationForm</a></li><li><a href="RemoveComponent.html">RemoveComponent</a></li><li><a href="TabsComponent.html">TabsComponent</a></li><li><a href="Unison.html">Unison</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DateSelector">DateSelector</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>Unison.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>

import PropTypes from 'prop-types';
import React, { useState, useEffect } from 'react';
import 'react-day-picker/lib/style.css';
import { formatDate } from 'react-day-picker/moment';
import './App.css';
import ARLocationComponent from './ARLocationComponent';
import { FORMAT, SELF } from './Constant';
import DateSelector from './DateSelector';
import { today, tomorrow, expandLink, problemConnecting } from './Util';
import HttpStatus from 'http-status-codes';

import { createLocationFactory, createRemoveFactory } from './closureFactory';

/**
 * Application component for Unison. Once mounted, it connects to the back-end to receive a list of the locations being tracked.
 * 
 * @component
 * 
 */
function Unison(props) {


  const [fromDate, setFromDate] = useState(today());
  const [toDate, setToDate] = useState(tomorrow());
  const [option, setOption] = useState(null);
  const [marker, setMarker] = useState(null);
  const [curLoc, setCurLoc] = useState(null);
  const [curVar, setCurVar] = useState(null);
  const [varOpt, setVarOpt] = useState(null);
  const [locationMap, setLocationMap] = useState(null);
  const [collectionModel, setCollectionModel] = useState(null);

  const obtainData = () => {

    class ResponseError extends Error {
      constructor(message, status) {
        super(message);
        this.status = status;
      }
    }

    function checkResponse(response, endpoint) {
      if (!response.ok)
        throw new ResponseError('Bad response for ' + endpoint, response.status);
    }

    async function requestFeatureCollection(uri) {
      const response = await fetch(uri, {
        method: 'GET',
        credentials: 'omit',
        headers: new Headers({
          'Accept': 'application/geo+json'
        })
      });


      checkResponse(response, uri);

      const fc = await response.json();

      const locationArray = fc.features;
      const n = locationArray.length;

      const newOption = [];
      const newMarker = [];

      for (let i = 0; i &lt; n; i++) {
        newOption.push(locationArray[i].properties.name);
        let pos = [locationArray[i].geometry.coordinates[1], locationArray[i].geometry.coordinates[0]];

        const properties = locationArray[i].properties;
        newMarker.push({ name: properties.name, position: pos });

      }

      if (n > 0) {

        setOption(newOption);
        setMarker(newMarker);


      } else {
        setOption(null);
        setMarker(null);
      }


    }

    const halGetHeader = {
      method: 'GET',
      credentials: 'omit',
      headers: new Headers({
        'Accept': 'application/hal+json'
      }),

    }

    function clearCurrent() {
      setCurLoc(null);
      setCurVar(null);
      setVarOpt(null);
      setLocationMap(null);

    }

    async function requestCollectionHAL(uri) {

      const response = await fetch(uri, halGetHeader);


      checkResponse(response, uri);

      const model = await response.json();


      setCollectionModel(model);

      if (model._embedded) {
        const list = model._embedded.locationModelList;
        const n = list.length;
        const map = new Map();
        for (let i = 0; i &lt; n; i++) {
          map.set(list[i].name, list[i]);
        }

        setLocationMap(map);

        const varOpt = [];

        if (n > 0) {

          for (const rel in list[0]._links) {
            if (SELF === rel) {
              continue;
            }

            const s = rel.charAt(0).toUpperCase() + rel.substring(1);
            let optName = '';
            let sw = 0;
            for (let i = 1; i &lt; s.length; i++) {
              const c = s.charAt(i);
              if (c >= 'A' &amp;&amp; c &lt;= 'Z') {
                optName += s.substring(sw, i) + ' ';
                sw = i;
              }
            }
            optName += s.substring(sw);
            varOpt.push(optName);
          }
        }
        if (varOpt.length > 0) {
          setCurLoc(list[0]);
          setCurVar(varOpt[0]);
          setVarOpt(varOpt);
          return;

        } else {

          clearCurrent();
          alert("No weather data is associated with the collection.")
        }


      } else {
        clearCurrent();
      }


    }

    async function requestModel() {
      try {

        const root = process.env.PUBLIC_URL;

        const response = await fetch(root, halGetHeader);

        checkResponse(response, root);


        const model = await response.json();

        const uri = model._links.locationCollection.href;
        await requestCollectionHAL(uri);
        await requestFeatureCollection(uri);

      } catch (e) {
        if (e instanceof ResponseError) {
          console.error("HTTP status code: " + e.status);

        }
        problemConnecting();

      }

    }


    requestModel();




  };

  useEffect(() => {

    obtainData();
  }, []);


  const updateCurLoc = (locationName) => {
    setCurLoc(locationMap.get(locationName));
  }

  const markerClicked = (location) => {
    updateCurLoc(location);
  }

  const _onLocationSelect = (event) => {

    updateCurLoc(event.target.value);

  }

  const _onVarSelect = (event) => {

    setCurVar(event.target.value);

  }

  const handleStartChange = (selectedDate) => {
    setFromDate(formatDate(selectedDate, FORMAT));

  }

  const handleEndChange = (selectedDate) => {

    setToDate(formatDate(selectedDate, FORMAT));

  }

  const spaceToUnderscore = (s) => {
    return s.replace(/ /g, '_')
  }


  const handleCSV = async () => {

    const response = await fetch(expandLink(curLoc, curVar, fromDate, toDate), {
      credentials: 'omit'
    });

    if (response.ok) {
      const blob = await response.blob();
      const a = document.createElement('a');
      a.href = window.URL.createObjectURL(blob);
      a.download = spaceToUnderscore(curLoc.name) + '_' + spaceToUnderscore(curVar) + '_'
        + fromDate + "_" + toDate + '.csv';
      a.click();
    } else if (response.status === HttpStatus.GATEWAY_TIMEOUT) {
      problemConnecting();
    }
  }


  function createSelector(label, dateValue, handleDayChange) {
    return &lt;DateSelector label={label} dateValue={dateValue} handleDayChange={handleDayChange} />;
  }

  return (

    &lt;div id="mapdiv">

      &lt;div id="logos">

        &lt;center>
          {props.logoLeft}
          {props.logoRight}
        &lt;/center>

      &lt;/div>

      {props.createMap(marker, curVar, locationMap, markerClicked, fromDate, toDate, curLoc)}

      &lt;div id="selectdiv" >

        &lt;center>

          &lt;div>
            {curLoc &amp;&amp; &lt;div id='variDD' >

              {varOpt &amp;&amp; &lt;select onChange={_onVarSelect}>

                {varOpt.map((opt) => &lt;option key={opt} value={opt}>{opt}&lt;/option>)}

              &lt;/select>}

            &lt;/div>}

            {curLoc &amp;&amp; &lt;div className='marginItem' >

              &lt;select onChange={_onLocationSelect} value={curLoc.name}>
                {!option &amp;&amp; &lt;option key="Location" value="Location" >Location&lt;/option>}
                {option &amp;&amp; option.map((opt) => &lt;option key={opt} value={opt}>{opt}&lt;/option>)}

              &lt;/select>

            &lt;/div>}


            &lt;div className='pLeft' >{
              createSelector("From date", fromDate, handleStartChange)
            }
            &lt;/div>

            &lt;div className='pLeft' >
              {
                createSelector("To date", toDate, handleEndChange)
              }
            &lt;/div>

            {curLoc &amp;&amp; curVar &amp;&amp; &lt;div className='pLeft'> &lt;button onClick={handleCSV}>CSV&lt;/button> &lt;/div>}
          &lt;/div>

          &lt;ARLocationComponent createLocation={createLocationFactory(obtainData, collectionModel)}
            createRemove={curLoc ? createRemoveFactory(obtainData, curLoc._links[SELF].href, curLoc.name) : null} />

        &lt;/center>

      &lt;/div>



    &lt;/div>
  );

}

Unison.propTypes = {

  /** A function for creating the map. */
  createMap: PropTypes.func.isRequired,

  /** A logo displayed at the bottom of the screen. It will be displayed to the left
   * if the logoRight prop is defined.
   */
  logoLeft: PropTypes.any,

  /** A logo displayed at the bottom of the screen. It will be displayed to the right
   * if the logoLeft prop is defined.
   */
  logoRight: PropTypes.any,

}

export default Unison;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

</body>
</html>
